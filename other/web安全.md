# web安全

## 密码

- 问题

弱密码和默认密码通常是网络中最容易实现的目标，它可以让攻击者获得最初的立足点。由于在许多情况下识别和利用漏洞所需的技能水平较低，因此对弱密码和默认密码的攻击尤其令人担忧。密码策略和这些策略的执行/审计是确保在组织范围内使用强密码的必要步骤。

如果没有强制执行最低密码复杂性的密码策略，暴露的每个帐户都可能成为潜在的攻击媒介。通过基于字典的简单密码猜测，多个帐户可以被攻破。

- 建议

审计师建议实施更严格的密码策略。根据行业最佳实践，在实施密码策略时需要考虑以下几点： 

1.最小密码长度 

密码长度设置密码的最少字符数。最小密码长度应为 12 个字符。

2.密码复杂性 

密码应满足复杂性要求。它不应包含任何真实姓名、用户名或公司名称。它应至少包含四个主要类别中的三个字符：一个大写字母、一个小写字母、一个数字和一个特殊字符。

3.密码历史 

密码历史设置可以重复使用旧密码的频率。应使用密码历史记录，以防止用户多次使用相同的密码。它可以包含用户的最后 20 个密码。

如果适用，应采取额外的安全措施： 最长和最短密码年龄。密码最长期限决定了用户在必须更改密码之前可以保留密码的时间。密码最短使用期限决定了用户在更改密码之前必须保留密码的时间。应限制用户立即更改密码以清除密码历史记录并返回旧密码。每个密码在更改之前至少会保持活动状态数天。密码的最长期限应设置为 4 个月，以确保定期更新密码。

4.使用弹性散列算法

确保在将密码保存到服务器或数据库时使用具有多次迭代的强加盐散列。目前，PBKDF2、scrypt、bcrypt等密钥派生函数使用起来比较安全。

5.将密码存储在密码保险箱中 

密码管理器可以帮助生成强大的随机密码。这允许用户将他的密码存储在加密容器中，同时为每个服务使用不同的密码。

6.密码审计 

定期密码审计有利于整体密码安全。这可以在内部或由外部方执行。此外，此审核涉及从数据库中提取密码哈希值，并尝试使用现代硬件和相应技术（词表、规则等）破解它们。应通知密码容易破解的用户并强制其更改或更新其凭据。这鼓励安全意识并直接提高密码质量。

7.两步验证 (2FA) 

使用两因素身份验证可以极大地帮助减轻对密码盗窃和密码暴力尝试的攻击。 

## 文件上传

- 问题

至少发现了一种形式，允许将具有任意内容和扩展名的文件上传到远程服务器。

如果攻击者能够将恶意文件上传到 Web 服务器，他很可能会危及服务器的安全，或者任何与上传内容交互的客户端计算机。通常，任意文件上传会导致以下一个或多个安全问题： 拒绝服务条件、使用 web shell 的远程代码执行 Waterhole 和/或旨在针对客户计算机的网络钓鱼攻击受版权保护的材料或恶意软件的分发点

- 建议

审核员建议遵循以下概述的步骤来保护上传表单： 当文件被上传并且在被服务器处理（写入磁盘）之前，文件名应该去除服务器上的所有控制、特殊或 Unicode 字符。检查上传文件的内容，并确认可接受、不可执行的内容类型的白名单。此外，确认常见可执行格式的黑名单，以阻止混合文件攻击。使用最新的扫描引擎（例如 VirusTotal、Valkyrie 等）检查上传的用户文件中是否存在恶意软件。强制执行可接受的、不可执行的文件扩展名的白名单。如果用户下载上传的文件，请提供准确的非通用 Content-Type 标头、X-Content-Type-Options: nosniff 标头，以及指定浏览器应将文件作为附件处理的 Content-Disposition 标头。对上传的文件及其名称实施大小限制（为了纵深防御，这可以实现在应用程序代码和 Web 服务器的配置中）。确保将文件写入不具有任何执行权限的目录，并且该目录中的所有文件都继承相同的权限。文件上传到的目录应该在网站根目录之外。 

## 跨域

- 问题

发现跨域资源 (CORS) 标头配置错误。 HTML5 跨域资源共享 (CORS) 策略控制在其他域上运行的内容是否以及如何与发布策略的域执行双向交互。该策略是细粒度的，可以根据请求的 URL 和其他功能对每个请求应用访问控制。除非响应仅包含未受保护的公共内容，否则发现的策略很可能会带来安全风险。

从审计员的角度来看，至少有两种配置会对用户及其会话产生破坏性影响。如果服务器响应包含以下标头组合，用户将面临巨大风险。前提条件：会话管理通过 Cookie、授权头或客户端证书执行。 `Access-Control-Allow-Origin：* 或 null, Access-Control-Allow-Credentials：true` 前提条件：会话管理通过 Cookie、授权标头或客户端证书执行。此外，请求中包含的 ORIGIN 头值由服务器解析并注入到 ACAO 头中。 `Access-Control-Allow-Origin：https://mycompany.com.attacker.com 或 https://notmycompany.com Access-Control-Allow-Credentials：true` 要利用上述配置，攻击者需要引诱经过身份验证的用户应用程序访问由攻击者托管的恶意网站。此外，在用户访问时，会触发 CORS 请求并将其发送到应用程序。 此 CORS 请求通知应用程序可以信任攻击者的网站（域）。之后，他不仅可以读取客户端的响应，还可以触发自己的身份验证请求。因此，第三方站点可能能够执行特权操作并检索敏感信息。即使没有，攻击者也可以通过用户浏览器代理来绕过任何基于 IP 的访问控制。 

## cookie

### httponly



### secure

- 问题

会话相关 Cookie 中缺少安全属性

在此过程中，审计员发现至少有一个与会话相关的 cookie 缺少安全属性。如果缺少此属性，则可以通过 HTTP 以纯文本形式传输 cookie。

如果攻击者建立了一种窃听用户连接的方法，并能够进一步强制从 HTTPS 降级到 HTTP，他很可能会成功窃取与会话相关的 cookie。因此，允许黑客查看或更改用户记录，并以该用户身份执行交易。还请注意，即使服务器不提供未加密的 HTTP 连接，此漏洞也会带来风险。这样做的原因是攻击者可以模拟这样的服务器。

- 建议

我们建议为所有与会话相关的 cookie 和那些传输敏感信息的 cookie 设置安全属性`secure=true`，以防止其内容通过未加密的 HTTP 请求被泄露。

### sameSite

- 问题 

至少有一个与会话相关的 cookie 缺少 SameSite 属性。如果缺少此属性，则在指示浏览器建立跨域请求时传输 cookie。

发出跨域请求时通常会包含会话 cookie。这种行为被跨站点请求伪造 (CSRF) 攻击滥用。如果应用程序没有或没有完全受到反 CSRF 方法的保护，设置 cookie 属性 SameSite 将导致有效缓解 CSRF 攻击。但是，一个要求是合法客户端的浏览器已经支持 SameSite cookie 属性。

- 建议

我们建议为所有与会话相关的 cookie 设置 SameSite 属性，以防止跨站点请求伪造攻击。想要确保高度机密的应用程序应将 SameSite 属性设置为“strict”。另一方面，“lax”值仍将允许用户点击第三方网页上的链接并已登录应用程序。

## 点击劫持

- 问题

攻击者控制的网页有可能在攻击者页面的 iframe 内加载此响应的内容。这可能会启用“点击劫持”攻击，其中攻击者的页面用攻击者提供的不同界面覆盖目标应用程序的界面。通过诱使受害用户执行诸如鼠标单击和击键等操作，攻击者可以使他们不知不觉地在目标应用程序中执行操作。请注意，报告此问题是因为应用程序的响应未设置合适的 X-Frame-Options 标头以防止帧攻击。一些应用程序尝试使用“framebusting”代码从 HTML 页面本身内部阻止这些攻击。然而，这种类型的防御通常是无效的，并且通常可以被熟练的攻击者规避。

这种技术允许攻击者绕过针对跨站点请求伪造的防御，并可能导致未经授权的操作。

- 建议

您应该查看可从响应中访问的应用程序功能，并确定应用程序用户是否可以使用它们在应用程序中执行任何敏感操作。如果是这样，那么针对此响应的帧攻击可能会导致未经授权的操作。为了有效地防止成帧攻击，应用程序应该返回一个名为 X-Frame-Options 的响应头和值 DENY 以完全阻止成帧，或返回值 SAMEORIGIN 以仅允许与响应本身相同来源的页面成帧。

nginx配置

```shell
# 添加到 ‘http’, ‘server’ 或者 ‘location’ 的配置项中

# 不允许在frame中展示
add_header X-Frame-Options DENY; 
# 可以在相同域名页面的frame中展示。
add_header X-Frame-Options SAMEORIGIN; 
# 表示该页面可以在指定来源的frame中展示。
add_header X-Frame-Options ALLOW-FROM http://whsir.com/; 
add_header X-Frame-Options "ALLOW-FROM http://whsir.com/,https://cacti.org.cn/";
```

## 内容安全策略

- 问题 

Web 应用程序不使用内容安全策略 (CSP)。如果使用得当，CSP 有助于防止由跨站点脚本等内容注入漏洞引起的常见攻击。此外，它的主要优点是通过用户浏览器处理的 HTTP 标头阻止客户端不受信任的资源。但是，仅通过设置新的 HTTP 标头无法实现 CSP。一般而言，CSP 的推出至少需要考虑以下元素： 数据和脚本代码的分离定义可信源，强化源代码以便通过 CSP 阻止 unsafe-eval 和 unsafe-inline 指令。如果您启用这些选项，跨站点脚本仍然是可能的。彻底测试，如果内容按预期显示。 CSP 限制加载 JavaScript 等资源的来源，并禁用不安全的 JavaScript 构造。默认情况下停用的构造包括： 内联 JavaScript 代码，例如 事件处理程序，直接在 HTML 代码中定义。示例：执行动态生成的 JavaScript 代码的函数。示例： eval ("doSomething") 

如果没有启用适当的内容安全策略，攻击者就更容易通过跨站点脚本攻击来利用用户的浏览器。

- 建议

从长远来看，审核员建议实施强大的内容安全策略，如下面提到的参考资料中所述。