# ç›‘å¬å™¨

æä¾›äº†8ä¸ªä¾¦å¬å™¨ï¼Œå¯ä»¥åœ¨workerè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¸­æ·»åŠ åŠŸèƒ½å‡½æ•°ã€‚

## æ¦‚è¿°

ä¸»è¿›ç¨‹ä¸­

```
main_process_start
main_process_stop
```

è‡ªåŠ¨åŠ è½½å¼€å¯æ—¶ï¼Œåœ¨åŠ è½½è¿›ç¨‹ä¸­

```
reload_process_start
reload_process_stop
```

æœåŠ¡å™¨å¯åŠ¨æˆ–å…³é—­æ—¶æ‰§è¡Œå¯åŠ¨/æ‹†å¸ä»£ç æ—¶

```
before_server_start
after_server_start
before_server_stop
after_server_stop
```

å¦‚æœæ­¤åº”ç”¨ç¨‹åºåœ¨å¯ç”¨è‡ªåŠ¨é‡æ–°åŠ è½½çš„æƒ…å†µä¸‹è¿è¡Œï¼Œåˆ™å½“é‡æ–°åŠ è½½ç¨‹åºè¿›ç¨‹å¯åŠ¨æ—¶ï¼Œ`reload_start`å‡½æ•°å°†è¢«è°ƒç”¨ä¸€æ¬¡ã€‚å½“ä¸»è¿›ç¨‹å¯åŠ¨æ—¶ï¼Œ`main_start`å‡½æ•°ä¹Ÿå°†è¢«è°ƒç”¨ä¸€æ¬¡ã€‚ä½†æ˜¯ï¼Œ`before-start`å‡½æ•°å°†ä¸ºæ¯ä¸ªå¯åŠ¨çš„å·¥ä½œè¿›ç¨‹è°ƒç”¨ä¸€æ¬¡ï¼Œéšåæ¯æ¬¡ä¿å­˜æ–‡ä»¶å¹¶é‡æ–°å¯åŠ¨å·¥ä½œè¿›ç¨‹æ—¶éƒ½ä¼šè°ƒç”¨ä¸€æ¬¡ã€‚

```python
@app.reload_process_start
async def reload_start(*_):
    print(">>>>>> reload_start <<<<<<")

@app.main_process_start
async def main_start(*_):
    print(">>>>>> main_start <<<<<<")
	
@app.before_server_start
async def before_start(*_):
	print(">>>>>> before_start <<<<<<")

```

## é™„åŠ 

`app.register_listener`

```python
async def setup_db(app):
    app.ctx.db = await db_setup()

app.register_listener(setup_db, "before_server_start")

```

è£…é¥°å™¨æ–¹æ³•`@app.`

```python
@app.listener("before_server_start")
async def setup_db(app):
    app.ctx.db = await db_setup()
    
# appå’Œloop
@app.listener("before_server_start")
async def setup_db(app, loop):
    app.ctx.db = await db_setup()

    
# ä¾¿æ·å†™æ³•
@app.before_server_start
async def setup_db(app):
    app.ctx.db = await db_setup()  
```

## æ‰§è¡Œé¡ºåº

| Phase                 | Order           |             |
| :-------------------- | :-------------- | ----------- |
| `main_process_start`  | main startup    | regular ğŸ™‚ â¬‡ï¸ |
| `before_server_start` | worker startup  | regular ğŸ™‚ â¬‡ï¸ |
| `after_server_start`  | worker startup  | regular ğŸ™‚ â¬‡ï¸ |
| `before_server_stop`  | worker shutdown | ğŸ™ƒ â¬†ï¸ reverse |
| `after_server_stop`   | worker shutdown | ğŸ™ƒ â¬†ï¸ reverse |
| `main_process_stop`   | main shutdown   | ğŸ™ƒ â¬†ï¸ reverse |

ç¤ºä¾‹

```python
@app.listener("before_server_start")
async def listener_1(app, loop):
    print("listener_1")

@app.before_server_start
async def listener_2(app, loop):
    print("listener_2")

@app.listener("after_server_start")
async def listener_3(app, loop):
    print("listener_3")

@app.after_server_start
async def listener_4(app, loop):
    print("listener_4")

@app.listener("before_server_stop")
async def listener_5(app, loop):
    print("listener_5")

@app.before_server_stop
async def listener_6(app, loop):
    print("listener_6")

@app.listener("after_server_stop")
async def listener_7(app, loop):
    print("listener_7")

@app.after_server_stop
async def listener_8(app, loop):
    print("listener_8")


"""
pid: 1000000 - The main process
pid: 1111111 - Worker 1
pid: 1222222 - Worker 2

[pid: 1000000] [INFO] Goin' Fast @ http://127.0.0.1:9999
[pid: 1000000] [INFO] listener_0
[pid: 1111111] [INFO] listener_1
[pid: 1111111] [INFO] listener_2
[pid: 1111111] [INFO] listener_3
[pid: 1111111] [INFO] listener_4
[pid: 1111111] [INFO] Starting worker [1111111]
[pid: 1222222] [INFO] listener_1
[pid: 1222222] [INFO] listener_2
[pid: 1222222] [INFO] listener_3
[pid: 1222222] [INFO] listener_4
[pid: 1222222] [INFO] Starting worker [1222222]
[pid: 1111111] [INFO] Stopping worker [1111111]
[pid: 1222222] [INFO] Stopping worker [1222222]
[pid: 1222222] [INFO] listener_6
[pid: 1222222] [INFO] listener_5
[pid: 1222222] [INFO] listener_8
[pid: 1222222] [INFO] listener_7
[pid: 1111111] [INFO] listener_6
[pid: 1111111] [INFO] listener_5
[pid: 1111111] [INFO] listener_8
[pid: 1111111] [INFO] listener_7
[pid: 1000000] [INFO] listener_9
[pid: 1000000] [INFO] Server Stopped
"""
```

## ä¼˜å…ˆçº§

ä¼˜å…ˆçº§è§„åˆ™

```
1.priorityå€¼ï¼Œ1>0
2.åº”ç”¨çº§>è“å›¾çº§
4.æ³¨å†Œé¡ºåºï¼Œå‰>å
```

ç¤ºä¾‹

```
@app.before_server_start  # é»˜è®¤priority=0
async def first(app):
    print("first")

@app.listener("before_server_start", priority=2)
async def second(app):
    print("second")

@app.before_server_start(priority=3)
async def third(app):
    print("third")

@bp.before_server_start
async def bp_first(app):
    print("bp_first")

@bp.listener("before_server_start", priority=2)
async def bp_second(app):
    print("bp_second")

@bp.before_server_start(priority=3)
async def bp_third(app):
    print("bp_third")

@app.before_server_start
async def fourth(app):
    print("fourth")

app.blueprint(bp)

"""
third
bp_third
second
bp_second
first
fourth
bp_first
"""
```

## ASGIæ—¶

è‹¥æ˜¯åº”ç”¨å®åœ¨`ASGI`æœåŠ¡æ—¶æ‰§è¡Œï¼Œæ³¨æ„ï¼š

1.`reload_process_start`å’Œ`reload_process_stop`ä¼šè¢«å¿½è§†

2.`main_process_start`å’Œ`main_process_stop`ä¼šè¢«å¿½è§†

3.`before_server_start`ä¼šå…ˆäº`after_server_start`æ‰§è¡Œï¼Œä½†æ˜¯æ­¤æ—¶æœåŠ¡å·²ç»åœ¨è¿è¡Œäº†ã€‚

4.`after_server_stop `ä¼šåäº`before_server_stop`æ‰§è¡Œï¼Œä½†æ˜¯æ­¤æ—¶æœåŠ¡è¿˜åœ¨è¿è¡Œäº†ã€‚
