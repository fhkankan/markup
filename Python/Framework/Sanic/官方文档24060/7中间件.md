# 中间件

中间件是在对服务器的请求之前或之后执行的功能。它们可用于修改对用户定义的处理函数的请求或响应。

中间件有两种类型：请求和响应。两者都使用`@app.middleware`装饰器声明，装饰器的参数是一个表示其类型的字符串：`'request'`或`'response'`。

- 请求中间件仅接收请求作为参数。
- 响应中间件同时接收请求和响应。

最简单的中间件根本不会修改请求或响应：

```python
@app.middleware('request')
async def print_on_request(request):
    print("I print when a request is received by the server")

@app.middleware('response')
async def print_on_response(request, response):
    print("I print when a response is returned by the server")
```

## 修改请求或响应

中间件可以修改给定的请求或响应参数，只要它不返回即可。以下示例显示了一个实际的用例。

```python
app = Sanic(__name__)


@app.middleware('request')
async def add_key(request):
    # Arbitrary data may be stored in request context:
    request.ctx.foo = 'bar'


@app.middleware('response')
async def custom_banner(request, response):
    response.headers["Server"] = "Fake-Server"


@app.middleware('response')
async def prevent_xss(request, response):
    response.headers["x-xss-protection"] = "1; mode=block"


@app.get("/")
async def index(request):
    return sanic.response.text(request.ctx.foo)


app.run(host="0.0.0.0", port=8000)
```

三个中间件按顺序执行：

1. 第一个请求中间件`add_key`将新的主键`foo`添加到请求上下文中。
2. 请求被路由到控制器`index`，该控制器从上下文获取主键`foo`并返回文本响应。
3. 第二个响应中间件`prevent_xss`添加了HTTP标头，以防止跨站点脚本（XSS）攻击。
4. 第一个响应中间件`custom_banner`将HTTP响应标头Server更改为Fake-Server

## 提前响应

如果中间件返回`HTTPResponse`对象，则该请求将停止处理并返回响应。如果在到达相关的用户路由处理程序之前在请求中发生这种情况，则永远不会调用该处理程序。返回响应也将阻止任何其他中间件运行。

```python
@app.middleware('request')
async def halt_request(request):
    return text('I halted the request')

@app.middleware('response')
async def halt_response(request, response):
    return text('I halted the response')
```

## 