# 常见用法

## 文件上传下载

- 上传

```python
async def file_upload(request):
    obj = request.form
    files = request.files
    # 只需获取单key多文件
    file_list = []  # 文件路径
    if files.get("img", ''):
        subpath = "cms/template/" + datetime.now().strftime("%Y-%m-%d")
        path = os.path.join(request.app.conf.FILE_UPLOAD_DIR, subpath)
        if not os.path.isdir(path): os.makedirs(path)
        for img in files["img"]:
            img_name = img.name
            img_body = img.body
            file_path = os.path.join(path, img_name)
            async with aiofiles.open(file_path, mode='wb') as fp:
                await fp.write(img_body)
            file_list.append(file_path)
```

示例2

```python
def detect_image_info(content):
    try:
        img = Image.open(BytesIO(content))
        return img.width, img.height, img.format.lower()
    except:
        return 0, 0, None


@bp.post("/<mall_id:int>/upload_batch")
async def material_upload_batch(request, mall_id):
    try:
        assert request.files, "不支持的post表单"
        subpath = "mall/" + datetime.now().strftime("%Y-%m-%d")
        path = os.path.join(request.app.conf.MATERIAL_UPLOAD_DIR, subpath)
        if not os.path.isdir(path): os.makedirs(path)
        ###
        mgr, results = request.app.mgr, []
        for _, form_files in request.files.items():
            for media in form_files:
                mtype, w, h, ext = 0, 0, 0, media.name.split(".")[-1]
                if media.type.startswith("video/") or media.type.startswith("audio/"):
                    mtype = 2
                else:
                    w, h, ext = detect_image_info(media.body)
                    if not ext:
                        results.append(dict(origin_filename=media.name, success=False))
                        continue
                ###
                fname = f"{uuid4()}.{ext}"
                base_path = os.path.join("/", subpath, fname)
                async with aiofiles.open(os.path.join(path, fname), mode='wb') as fp:
                    await fp.write(media.body)
                data = dict(
                    mall_id=mall_id, material_type=mtype,
                    base_path=base_path,
                    width=w, height=h, size=len(media.body),
                    origin_filename=media.name,
                )
                got = await mgr.execute(MaterialInfo.insert(data))
                results.append(dict(data, success=True))
        return json(dict(code=RC.OK, msg="ok", data=results))
    except AssertionError as ex:
        return json(dict(code=RC.PARSER_FAILED, msg=str(ex)))
    except Exception as ex:
        logger.exception(ex)
        return json(dict(code=RC.INTERNAL_ERROR, msg="服务内部故障"))
```

- 下载

```python
async def store_user_info(req):
    session_id = get_session_id(req)
    app = req.app
    imcd_db = app.imcd_db
    user_obj = req.json
    openid, unionid = await app.common_session.get_wxids(session_id)
    img_url = user_obj.get("avatarUrl", '')
    if img_url:
        base_path = app.env_config.AVATAR_PATH
        now_dt = datetime.now().strftime("%Y%m%d")
        img_folder = '%s/%s' % (now_dt, openid)
        # img_type = img_url[img_url.rindex(".") + 1:]
        img_name = '%s/%s' % (img_folder, str(uuid4()))
        img_path = "%s/%s" % (base_path, img_name)
        if not os.path.exists(os.path.join(base_path, img_folder)):
            os.makedirs(os.path.join(base_path, img_folder))
        try:
            async with app.client_session.get(img_url) as resp:
                async with aiofiles.open(img_path, 'wb') as fd:
                    while 1:
                        chunk = await resp.content.read(1024)  # 每次获取1024字节
                        if not chunk:
                            break
                        await fd.write(chunk)
        except Exception as e:
            logger.error("download avatar error: %s" % openid)
            logger.exception(e)
            return json(dict(code=53003, msg="下载头像失败"))

```





