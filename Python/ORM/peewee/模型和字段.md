# 模型和字段

## 概述

模型类、字段实例和模型实例都映射到数据库概念：

| Thing          | Corresponds to…         |
| -------------- | ----------------------- |
| Model class    | Database table          |
| Field instance | Column on a table       |
| Model instance | Row in a database table |

下面的代码显示了定义数据库连接和模型类的典型方式。

```python
import datetime
from peewee import *

db = SqliteDatabase('my_app.db')

class BaseModel(Model):
    class Meta:
        database = db

class User(BaseModel):
    username = CharField(unique=True)

class Tweet(BaseModel):
    user = ForeignKeyField(User, backref='tweets')
    message = TextField()
    created_date = DateTimeField(default=datetime.datetime.now)
    is_published = BooleanField(default=True)
```

## 字段

Field类用于描述模型属性到数据库列的映射。每个字段类型都有一个对应的SQL存储类（即varchar、int），python数据类型和底层存储之间的转换是透明的。

创建模型类时，字段定义为类属性。对于django框架的用户来说，这应该很熟悉。举个例子：

```python
class User(Model):
    username = CharField()
    join_date = DateTimeField()
    about_me = TextField()
```

在上面的示例中，由于没有一个字段是用`primary_key=True`初始化的，因此将自动创建一个自动递增的主键并命名为“id”。Peewee使用`AutoField`表示一个自动递增的整数主键，这意味着`primary_key=True`。

有一种特殊类型的字段`ForeignKeyField`，它允许您以直观的方式表示模型之间的外键关系：

```python
class Message(Model):
    user = ForeignKeyField(User, backref='messages')
    body = TextField()
    send_date = DateTimeField(default=datetime.datetime.now)
```

使用

```python
>>> print(some_message.user.username)
Some User

>>> for message in some_user.messages:
...     print(message.body)
some message
another message
yet another message
```

### 字段类型表

| Field Type          | Sqlite        | Postgresql       | MySQL            |
| ------------------- | ------------- | ---------------- | ---------------- |
| `AutoField`         | integer       | serial           | integer          |
| `BigAutoField`      | integer       | bigserial        | bigint           |
| `IntegerField`      | integer       | integer          | integer          |
| `BigIntegerField`   | integer       | bigint           | bigint           |
| `SmallIntegerField` | integer       | smallint         | smallint         |
| `IdentityField`     | not supported | int identity     | not supported    |
| `FloatField`        | real          | real             | real             |
| `DoubleField`       | real          | double precision | double precision |
| `DecimalField`      | decimal       | numeric          | numeric          |
| `CharField`         | varchar       | varchar          | varchar          |
| `FixedCharField`    | char          | char             | char             |
| `TextField`         | text          | text             | text             |
| `BlobField`         | blob          | bytea            | blob             |
| `BitField`          | integer       | bigint           | bigint           |
| `BigBitField`       | blob          | bytea            | blob             |
| `UUIDField`         | text          | uuid             | varchar(40)      |
| `BinaryUUIDField`   | blob          | bytea            | varbinary(16)    |
| `DateTimeField`     | datetime      | timestamp        | datetime         |
| `DateField`         | date          | date             | date             |
| `TimeField`         | time          | time             | time             |
| `TimestampField`    | integer       | integer          | integer          |
| `IPField`           | integer       | bigint           | bigint           |
| `BooleanField`      | integer       | boolean          | bool             |
| `BareField`         | untyped       | not supported    | not supported    |
| `ForeignKeyField`   | integer       | integer          | integer          |

### 字段初始化参数

所有字段类型接受的参数及其默认值：

- `null = False` – allow null values
- `index = False` – create an index on this column
- `unique = False` – create a unique index on this column. See also [adding composite indexes](http://docs.peewee-orm.com/en/latest/peewee/models.html#model-indexes).
- `column_name = None` – explicitly specify the column name in the database.
- `default = None` – any value or callable to use as a default for uninitialized models
- `primary_key = False` – primary key for the table
- `constraints = None` - one or more constraints, e.g. `[Check('price > 0')]`
- `sequence = None` – sequence name (if backend supports it)
- `collation = None` – collation to use for ordering the field / index
- `unindexed = False` – indicate field on virtual table should be unindexed (**SQLite-only**)
- `choices = None` – optional iterable containing 2-tuples of `value`, `display`
- `help_text = None` – string representing any helpful text for this field
- `verbose_name = None` – string representing the “user-friendly” name of this field
- `index_type = None` – specify a custom index-type, e.g. for Postgres you might specify a `'BRIN'` or `'GIN'` index.

### 有些字段采用特殊参数…

| Field type                                                   | Special Parameters                                           |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [`CharField`](http://docs.peewee-orm.com/en/latest/peewee/api.html#CharField) | `max_length`                                                 |
| [`FixedCharField`](http://docs.peewee-orm.com/en/latest/peewee/api.html#FixedCharField) | `max_length`                                                 |
| [`DateTimeField`](http://docs.peewee-orm.com/en/latest/peewee/api.html#DateTimeField) | `formats`                                                    |
| [`DateField`](http://docs.peewee-orm.com/en/latest/peewee/api.html#DateField) | `formats`                                                    |
| [`TimeField`](http://docs.peewee-orm.com/en/latest/peewee/api.html#TimeField) | `formats`                                                    |
| [`TimestampField`](http://docs.peewee-orm.com/en/latest/peewee/api.html#TimestampField) | `resolution`, `utc`                                          |
| [`DecimalField`](http://docs.peewee-orm.com/en/latest/peewee/api.html#DecimalField) | `max_digits`, `decimal_places`, `auto_round`, `rounding`     |
| [`ForeignKeyField`](http://docs.peewee-orm.com/en/latest/peewee/api.html#ForeignKeyField) | `model`, `field`, `backref`, `on_delete`, `on_update`, `deferrable` `lazy_load` |
| [`BareField`](http://docs.peewee-orm.com/en/latest/peewee/api.html#BareField) | `adapt`                                                      |

### 默认字段值

Peewee可以在创建对象时为字段提供默认值。例如，要使IntegerField的默认值为零而不是NULL，可以使用默认值声明字段：

```python
class Message(Model):
    context = TextField()
    read_count = IntegerField(default=0)
```

在某些情况下，默认值是动态的可能是有意义的。一个常见的场景是使用当前日期和时间。Peewee允许您在这些情况下指定一个函数，其返回值将在创建对象时使用。注意：我们只提供函数，实际上不调用它：

```python
class Message(Model):
    context = TextField()
    timestamp = DateTimeField(default=datetime.datetime.now)
```

> 注意
>
> 如果您使用的字段接受可变类型（list、dict等），并且希望提供默认值，那么最好将默认值包装在一个简单函数中，这样多个模型实例就不会共享对同一基础对象的引用：

```python
def house_defaults():
    return {'beds': 0, 'baths': 0}

class House(Model):
    number = TextField()
    street = TextField()
    attributes = JSONField(default=house_defaults)
```

数据库还可以为字段提供默认值。虽然peewee没有显式提供用于设置服务器端默认值的API，但可以使用`constraints`参数指定服务器默认值：

```python
class Message(Model):
    context = TextField()
    timestamp = DateTimeField(constraints=[SQL('DEFAULT CURRENT_TIMESTAMP')])
```

> 注意
>
> 使用默认参数时，值由Peewee设置，而不是实际表和列定义的一部分。

### 外键

`ForeignKeyField`是一种特殊的字段类型，允许一个模型引用另一个模型。通常，外键将包含与其相关模型的主键（但可以通过指定字段来指定特定列）。

外键允许数据标准化。在我们的示例模型中，Tweet和User之间有一个外键。这意味着所有用户都存储在自己的表中，tweet也是如此，tweet-to-user的外键允许每条tweet指向特定的用户对象。

在peewee中，访问ForeignKeyField的值将返回整个相关对象。

```python
tweets = (Tweet
          .select(Tweet, User)
          .join(User)
          .order_by(Tweet.created_date.desc()))
for tweet in tweets:
    print(tweet.user.username, tweet.message)
```







## 创建模型表

## 模型选项和表格元数据

## 索引和约束

## 主键和组合键

## 自关联外键

## 循环外键依赖

