# 异步实现

`peewee_async`

[文档](https://peewee-async.readthedocs.io/en/latest/)

## 查

### 单行

```python
# 不能执行
await mgr.execute(PurchaseCompany.get(PurchaseCompany.company_id == comp_id))

# 不存在时返回对象为空列表, 存在时obj[0]是字典
comp_obj = await mgr.execute(PurchaseCompany.select().where(PurchaseCompany.company_id == comp_id).dicts())

# 不存在时触发DoesNotExist,存在时是model对象
comp_obj = await mgr.get(PurchaseCompany, company_id=comp_id)
```

### 多行

```python
# 返回字典组成的列表
comp_obj = await mgr.execute(PurchaseCompany.select().paginate(page_no, per_page).dicts()
```

### 排序

```python
where = []
await mgr.execute(UserFavorite.select()
            .where(*where)
            .order_by(UserFavorite.favorite_id.desc())
            .paginate(page_id, page_size))
```

### 聚合

- Count

```python
# 存在时obj[0]是字典， 不存在是空
comp_counts = await mgr.execute(PurchaseCompany.select(fn.COUNT(PurchaseCompany.company_id).alias("count")).dicts())
# 存在时obj[0]是对象， 不存在是空
comp_counts = await mgr.execute(PurchaseCompany.select(fn.COUNT(PurchaseCompany.company_id).alias("count")))


# 返回行数
comp_counts = await mgr.count(PurchaseCompany.select().where(PurchaseCompany.company_id > 0))
```

- grouppy

```python
await mgr.execute(MaterialTag.select(
            MaterialTag.tag,
            fn.COUNT(MaterialTag.material_id).alias('total'),
        ).where(
            MaterialTag.mall_id == mall_id,
            MaterialTag.removed == 0,
        ).group_by(
            MaterialTag.tag,
        ))
```



### join



## 增

### 单行

```python
# 不能执行
await mgr.execute(PurchaseCompany.create(company_name=name, aes_key=aes, app_secret_key=sec))

# 执行成功，返回影响行数
await  mgr.execute(PurchaseCompany.insert(company_name=name, aes_key=aes, app_secret_key=sec))

data = await dict(mall_id=mall_id, material_type=mtype)
await mgr.execute(MaterialInfo.insert(data))


 
  
# 执行成功，返回Model对象
 await mgr.create(PurchaseCompany, company_name=name, aes_key=aes, app_secret_key=sec)
```

### 多行

```python
item_todo = [{},{}]
got = await app.mgr.execute(OrderItem.insert_many(item_todo))
```



## 改

```python
# 执行成功，返回影响的行数
await mgr.execute(PurchaseCompany.update(emp_list=comp_obj.emp_list).where(
    PurchaseCompany.company_id == comp_id))

await mgr.execute(UserAddress.update({ UserAddress.is_default: False,}).where(
    UserAddress.user_id == user_id, UserAddress.address_id != address_id))


mgr.execute(MaterialTag.replace({
                    MaterialTag.mall_id: mall_id,
                    MaterialTag.tag: tag,
                    MaterialTag.material_id: mid,
                    MaterialTag.removed: 0,
                }))


# 执行成功，返回影响的行数，与get配合使用
comp_obj = await mgr.get(PurchaseCompany, company_id=comp_id)
await mgr.update(comp_obj)
```



## 删



## 原生sql

```python
sql = """
SELECT g.goods_id, g.goods_name, g.goods_alias, g.goods_type, g.rv,
       g.min_price, g.min_score, g.poster_image, g.share_image, g.share_words,
       g.sales_base, g.sales_actual, g.swiper_list, b.head_sku_id,
       s.outer_sku_code, s.spec_value_1, s.spec_value_2,
       s.thumb_icon, s.origin_price, s.sale_price, s.cost_score, s.quantity
FROM t_mall_goods_recommend b
LEFT JOIN t_mall_goods_info g ON b.goods_id=g.goods_id
LEFT JOIN t_mall_sku_info s ON b.head_sku_id=s.sku_id
WHERE b.source_goods_id IN %s AND b.removed=0;
"""

results = await mgr.execute(GoodsInfo.raw(q_recommended_list, [goods_id]))
```

